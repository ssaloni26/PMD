name: PMD & CPD PR Check
on:
  pull_request:
    paths:
       - 'force-app/**' 
       - 'force-app/main/default/classes/**'
       - 'config/pmd/**'
jobs:
  pmd-cpd:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        
      - name: Set up Java
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '17'
          
      - name: Download and Setup PMD
        run: |
          wget https://github.com/pmd/pmd/releases/download/pmd_releases%2F6.55.0/pmd-bin-6.55.0.zip
          unzip pmd-bin-6.55.0.zip
          chmod +x pmd-bin-6.55.0/bin/run.sh
          
       - name: Run PMD (Apex)
        run: |
          echo "Checking if ruleset exists:"
          ls -l config/pmd/
          echo "Checking files to analyze:"
          ls -l force-app/main/default/classes/
          
          # Run PMD and capture exit code
          pmd-bin-6.55.0/bin/run.sh pmd \
            -d force-app/main/default/classes \
            -R config/pmd/apex-ruleset.xml \
            -f text \
            -r pmd-report.txt \
            --minimum-priority 1 || PMD_EXIT=$?
          
          # Display the report
          if [ -f pmd-report.txt ]; then
            echo "PMD Report:"
            cat pmd-report.txt
          else
            echo "No PMD report generated"
          fi
          
          # Check for Priority 1 issues
          if [ -f pmd-report.txt ] && grep -q "Priority: 1" pmd-report.txt; then
            echo "❌ PMD found Priority 1 (Blocker) issues"
            exit 1
          else
            echo "✅ No Priority 1 PMD issues found."
          fi

          
      - name: Upload PMD report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: pmd-report
          path: pmd-report.txt
          
      - name: Run CPD (Apex duplication)
        run: |
          pmd-bin-6.55.0/bin/run.sh cpd \
            --minimum-tokens 50 \
            --language apex \
            --files force-app/main/default/classes \
            --format text > cpd-report.txt || true
          cat cpd-report.txt
          if grep -q "Found a duplication" cpd-report.txt; then
            echo "❌ CPD found duplicate Apex code"
            exit 1
          else
            echo "✅ No duplication issues found."
          fi
          
      - name: Upload CPD report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: cpd-report
          path: cpd-report.txt
