name: PMD & CPD PR Check

on:
  pull_request:
    paths:
      - 'force-app/**'
      - 'config/pmd/**'

jobs:
  pmd-cpd:
    runs-on: ubuntu-latest

    steps:
      # 1️⃣ Checkout repo
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2️⃣ Setup Java (PMD requires Java 17)
      - name: Set up Java
        uses: actions/setup-java@v3
        with:
          distribution: temurin
          java-version: 17

      # 3️⃣ Download & setup PMD
      - name: Download and setup PMD
        run: |
          wget https://github.com/pmd/pmd/releases/download/pmd_releases/6.55.0/pmd-bin-6.55.0.zip
          unzip -q pmd-bin-6.55.0.zip
          chmod +x pmd-bin-6.55.0/bin/run.sh

      # 4️⃣ Add PMD to PATH
      - name: Add PMD to PATH
        run: echo "$GITHUB_WORKSPACE/pmd-bin-6.55.0/bin" >> $GITHUB_PATH

      # 5️⃣ Run PMD for Apex classes only (Security rules)
      - name: Run PMD (Apex Security)
        run: |
          SCAN_DIRS="force-app/main/default/classes"

          echo "Scanning directories: $SCAN_DIRS"

          run.sh pmd \
            -d $SCAN_DIRS \
            -R config/pmd/security-only-apex.xml \
            -f text > pmd-report.txt || true

          cat pmd-report.txt

          if grep -q "Priority: 1" pmd-report.txt; then
            echo "❌ PMD found Priority 1 (Blocker) issues"
            exit 1
          else
            echo "✅ No Priority 1 PMD issues found."
          fi

      # 6️⃣ Upload PMD report
      - name: Upload PMD report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: pmd-report
          path: pmd-report.txt

      # 7️⃣ Run CPD for Apex classes only
      - name: Run CPD (Apex duplication)
        run: |
          SCAN_DIRS="force-app/main/default/classes"

          echo "CPD scanning directories: $SCAN_DIRS"

          run.sh cpd \
            --minimum-tokens 50 \
            --language apex \
            --files $SCAN_DIRS \
            --format text > cpd-report.txt || true

          cat cpd-report.txt

          if grep -q "Found a duplication" cpd-report.txt; then
            echo "❌ CPD found duplicate Apex code"
            exit 1
          else
            echo "✅ No duplication issues found."
          fi

      # 8️⃣ Upload CPD report
      - name: Upload CPD report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: cpd-report
          path: cpd-report.txt
