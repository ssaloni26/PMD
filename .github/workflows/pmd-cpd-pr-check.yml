name: PMD & CPD PR Check
on:
  pull_request:
    paths:
       - 'force-app/**' 
       - 'force-app/main/default/classes/**'
       - 'force-app/main/default/triggers/**'
       - 'config/pmd/**'
jobs:
  pmd-cpd:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        
      - name: Set up Java
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '17'
          
      - name: Download and Setup PMD
        run: |
          wget https://github.com/pmd/pmd/releases/download/pmd_releases%2F6.55.0/pmd-bin-6.55.0.zip
          unzip pmd-bin-6.55.0.zip
          chmod +x pmd-bin-6.55.0/bin/pmd
          chmod +x pmd-bin-6.55.0/bin/cpd
          
      - name: Run PMD (Apex)
        run: |
          ./pmd-bin-6.55.0/bin/pmd check \
            -d force-app/main/default/classes,force-app/main/default/triggers \
            -R config/pmd/apex-ruleset.xml \
            -f text > pmd-report.txt || true
          cat pmd-report.txt
          if grep -q "Priority: 1" pmd-report.txt; then
            echo "❌ PMD found Priority 1 (Blocker) issues"
            exit 1
          else
            echo "✅ No Priority 1 PMD issues found."
          fi
          
      - name: Upload PMD report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: pmd-report
          path: pmd-report.txt
          
      - name: Run CPD (Apex duplication)
        run: |
          ./pmd-bin-6.55.0/bin/cpd \
            --minimum-tokens 50 \
            --language apex \
            --files force-app/main/default/classes \
            --format text > cpd-report.txt || true
          cat cpd-report.txt
          if grep -q "Found a duplication" cpd-report.txt; then
            echo "❌ CPD found duplicate Apex code"
            exit 1
          else
            echo "✅ No duplication issues found."
          fi
          
      - name: Upload CPD report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: cpd-report
          path: cpd-report.txt
