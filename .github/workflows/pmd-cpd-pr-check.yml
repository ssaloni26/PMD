name: PMD & CPD PR Check

on:
  pull_request:
    paths:
      - 'force-app/main/default/classes/**'
      - 'config/pmd/**'

jobs:
  pmd-cpd:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 3️⃣ Download and setup PMD
      - name: Download and Setup PMD
        run: |
          wget https://github.com/pmd/pmd/releases/download/pmd_releases%2F6.55.0/pmd-bin-6.55.0.zip
          unzip pmd-bin-6.55.0.zip
          chmod +x pmd-bin-6.55.0/bin/run.sh

      # ---------------- PMD ----------------
      
      - name: Get changed Apex files
        id: changed-files
        run: |
          git fetch origin ${{ github.base_ref }}

          CHANGED_FILES=$(git diff --name-only origin/${{ github.base_ref }}...HEAD \
            | grep '^force-app/main/default/classes/.*\.cls$' 
            | grep -v '^force-app/main/default/classes/excluded/' \   # exclude a folder
            | grep -v '^force-app/main/default/classes/DMLAuditAI.cls$' \ # exclude specific file
            || true)

          echo "$CHANGED_FILES"

          # Convert to comma-separated list for PMD/CPD
          FILE_LIST=$(echo "$CHANGED_FILES" | tr '\n' ',' | sed 's/,$//')

          echo "FILES=$FILE_LIST" >> $GITHUB_ENV
      - name: Run PMD (Apex)
        continue-on-error: true
        run: |
          pmd-bin-6.55.0/bin/run.sh pmd \
            -d "$FILES" \
            -R config/pmd/apex-ruleset.xml \
            -f text > pmd-report.txt

      - name: Upload PMD report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: pmd-report
          path: pmd-report.txt

      # ---------------- CPD ----------------
      - name: Run CPD (Apex duplication)
        continue-on-error: true
        run: |
            pmd-bin-6.55.0/bin/run.sh cpd \
                --minimum-tokens 50 \
                --language apex \
                --files "$FILES" \
                --format text > cpd-report.txt


      - name: Upload CPD report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: cpd-report
          path: cpd-report.txt
          if-no-files-found: warn



      # ---------------- FINAL GATE ----------------
      - name: Final Quality Gate
        run: |
          echo "Checking PMD and CPD reports..."

          PMD_FAIL=0
          CPD_FAIL=0

          # Check PMD Priority 1
          if grep -q "Priority: 1" pmd-report.txt; then
            echo "❌ PMD Priority 1 issues found"
            PMD_FAIL=1
          else
            echo "✅ No PMD Priority 1 issues"
          fi

          # Check CPD duplications
          if grep -q "Found a duplication" cpd-report.txt; then
            echo "❌ CPD duplications found"
            CPD_FAIL=1
          else
            echo "✅ No CPD duplications"
          fi

          # Final exit
          if [ $PMD_FAIL -eq 1 ] || [ $CPD_FAIL -eq 1 ]; then
            echo "❌ Quality gate failed"
            exit 1
          else
            echo "✅ Quality gate passed"
          fi
