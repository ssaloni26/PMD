name: PMD & CPD PR Check

on:
  pull_request:
    paths:
      - 'force-app/main/default/classes/**'
      - 'config/pmd/**'

jobs:
  pmd-cpd:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      # ---------------- PMD ----------------
      - name: Run PMD (Apex)
        continue-on-error: true
        run: |
          pmd check \
            --dir force-app/main/default/classes \
            --rulesets config/pmd/apex-ruleset.xml \
            --format text \
            --report-file pmd-report.txt

      - name: Upload PMD report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: pmd-report
          path: pmd-report.txt

      # Set PMD flag based on Priority 1 only
      - name: Evaluate PMD result
        if: always()
        run: |
          if grep -q "Priority: 1" pmd-report.txt; then
            echo "PMD_EXIT_CODE=1" >> $GITHUB_ENV
          else
            echo "PMD_EXIT_CODE=0" >> $GITHUB_ENV
          fi

      # ---------------- CPD ----------------
      - name: Run CPD (Apex duplication)
        continue-on-error: true
        run: |
          pmd cpd \
            --language apex \
            --minimum-tokens 75 \
            --files force-app/main/default/classes \
            --format text \
            --output cpd-report.txt

      - name: Upload CPD report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: cpd-report
          path: cpd-report.txt
          if-no-files-found: warn

      # Set CPD flag if duplication found
      - name: Evaluate CPD result
        if: always()
        run: |
          if grep -q "Found a duplication" cpd-report.txt; then
            echo "CPD_EXIT_CODE=1" >> $GITHUB_ENV
          else
            echo "CPD_EXIT_CODE=0" >> $GITHUB_ENV
          fi

      # ---------------- FINAL GATE ----------------
      - name: Final Quality Gate
        if: always()
        run: |
          echo "PMD_EXIT_CODE=$PMD_EXIT_CODE"
          echo "CPD_EXIT_CODE=$CPD_EXIT_CODE"

          if [ "$PMD_EXIT_CODE" == "1" ] || [ "$CPD_EXIT_CODE" == "1" ]; then
            echo "❌ Quality gate failed: PMD Priority 1 or CPD duplication found"
            exit 1
          else
            echo "✅ Quality gate passed: No critical PMD or CPD issues"
          fi
