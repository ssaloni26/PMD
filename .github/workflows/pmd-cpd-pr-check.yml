name: PMD & CPD PR Check

on:
  pull_request:
    paths:
      - 'force-app/**'
      - 'force-app/main/default/classes/**'
      - 'config/pmd/**'

jobs:
  pmd-cpd:
    runs-on: ubuntu-latest
    steps:
      # 1️⃣ Checkout repository
      - name: Checkout repo
        uses: actions/checkout@v4

      # 2️⃣ Setup Java
      - name: Set up Java
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '17'

      # 3️⃣ Download and setup PMD
      - name: Download and Setup PMD
        run: |
          wget https://github.com/pmd/pmd/releases/download/pmd_releases%2F6.55.0/pmd-bin-6.55.0.zip
          unzip pmd-bin-6.55.0.zip
          chmod +x pmd-bin-6.55.0/bin/run.sh

      # 4️⃣ Run PMD (Apex)
      - name: Run PMD (Apex)
        run: |
          echo "Checking if ruleset exists:"
          ls -l config/pmd
          echo "Checking files to analyze:"
          ls -l force-app/main/default/classes

          # Correct syntax: "pmd" must be the first argument
          pmd-bin-6.55.0/bin/run.sh pmd \
            -d force-app/main/default/classes \
            -R config/pmd/apex-ruleset.xml \
            -f text > pmd-report.txt
            --verbose

          cat pmd-report.txt

          if grep -q "Priority: 1" pmd-report.txt; then
            echo "❌ PMD found Priority 1 (Blocker) issues"
            exit 1
          else
            echo "✅ No Priority 1 PMD issues found."
          fi

      # 5️⃣ Upload PMD report
      - name: Upload PMD report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: pmd-report
          path: pmd-report.txt

      # 6️⃣ Run CPD (duplicate code detection)
      - name: Run CPD (Apex duplication)
        run: |
          echo "Running CPD duplicate check..."

          # Run CPD but do NOT stop execution on duplicates
          pmd-bin-6.55.0/bin/run.sh cpd \
            --minimum-tokens 50 \
            --language apex \
            --files force-app/main/default/classes \
            --format text > cpd-report.txt || true

          echo "===== CPD REPORT ====="
          cat cpd-report.txt

          # Fail PR only AFTER report is generated
          if grep -q "Found a duplication" cpd-report.txt; then
            echo "❌ CPD found duplicate Apex code"
            exit 1
          else
            echo "✅ No duplicate Apex code found"
          fi

      # 7️⃣ Upload CPD report
      - name: Upload CPD report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: cpd-report
          path: cpd-report.txt
